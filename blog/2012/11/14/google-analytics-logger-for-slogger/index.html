<!doctype html><html><head><meta charset=utf-8><meta name=keywords content><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFJ7SZKLR0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFJ7SZKLR0",{anonymize_ip:!1})}</script><meta name=robots content="index,follow"><link rel=stylesheet href=https://hiltmon.com/css/main.css><link rel=stylesheet href=https://hiltmon.com/css/all.css><link rel=stylesheet href=https://hiltmon.com/css/carbon.css><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic' rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><title>Google Analytics Logger for Slogger</title></head><body><div id=container><header id=header><img id=logo src=https://hiltmon.com/images/hiltmon-logo-174.png><h1 id=title><a href=https://hiltmon.com/>Hiltmon</a></h1><h2 id=sub-title>On walkabout in life and technology</h2></header><nav id=menu><ul><li><a href=https://hiltmon.com/about/ title="about me">About</a></li><li><a href=https://hiltmon.com/ title="blog section">Blog</a></li><li><a href=https://hiltmon.com/code/ title=code>Code</a></li><li><a href=https://hiltmon.com/tags/ title="tags section">Tags</a></li><li><a href=https://hiltmon.com/archives/ title="archives section">Archives</a></li></ul></nav><section id=content><p class=meta-data><span class=post-date>Nov 14, 2012 9:14 AM</span></p><div class=tag-group><div class=tag><span class=tag-text>| <a href=https://hiltmon.com/tags/slogger>Slogger</a></span></div></div><h1 class=post-title>Google Analytics Logger for Slogger</h1><div class=post-body><p>This article explains how to set up Brett Terpstra&rsquo;s <a href=http://ttscoff.github.com/Slogger/>Slogger</a> with a new plugin to journal your daily Google Analytics site stats. This plugin supports:</p><ul><li>Multiple web properties as long as they are under the same Google login.</li><li>Multiple dates so you can skip a few Slogger run days and catch up (or back fill).</li><li>Only logs a full day&rsquo;s worth of stats, so if it runs now, it logs up to yesterday&rsquo;s stats.</li><li>Captures page views, visitors, top 5 sources and top 10 popular pages. If you want different stats, let me know in the comments or via App.net <a href=http://alpha.app.net/hiltmon>@hiltmon</a> or Twitter <a href=https://twitter.com/hiltmon>@hiltmon</a>.</li></ul><p><strong>Warning: This plugin is <em>alpha</em> code, so assume the usual no warranty legalize, basically proceed at your own peril.</strong></p><p>Note also that this plugin is only two days old as this gets posted, whereas the access token lasts 2 weeks, so the OAuth 2.0 renewal code has not yet been tested.</p><p><em>Finally, I tend to try to make installation instructions as explicit as possible, so please bear with me as there are quite a few steps here.</em></p><h2 id=installing-the-plugin>Installing the Plugin</h2><p>Follow these to install and configure the plugin. If any steps are unclear, check out the detailed instructions below.</p><h3 id=quick-install-instructions>Quick Install Instructions</h3><ul><li>Install the <code>google-api-client</code> gem</li><li>Save <a href=https://gist.github.com/4072068>Gist 4072068</a> as <code>plugins/googleanalyticsclient.rb</code></li><li>Patch <code>slogger</code> using <a href=https://gist.github.com/4072079>Gist 4072079</a></li><li>Run <code>/slogger -o Google</code> to create the <code>slogger_config</code> entry</li><li>Add your web properties UA codes <em>and</em> paste in the client_id and secret</li></ul><pre tabindex=0><code>  client_id: &#34;237632137636.apps.googleusercontent.com&#34;
  client_secret: &#34;xUgp_NqKHnyJ_b8cwZbR1tnX&#34;
</code></pre><ul><li>Run <code>/slogger -o Google</code> again to launch a browser, authenticate and provide an <code>auth_code</code>. Paste that into <code>slogger_config</code> under <code>auth_code</code>.</li><li>Run <code>/slogger -o Google</code> a third time to get an <code>access_token</code> and create the first entries</li></ul><h3 id=detailed-installation-instructions>Detailed Installation Instructions</h3><p>If you are here, I assume you already have Slogger installed and running. As of writing this, I am on version 2.14.2.</p><p>Open a terminal and <code>cd</code> to your slogger folder (in my case that&rsquo;s in <code>~/Scripts/Slogger</code>. Run all commands from there.</p><p><strong>Install the Google API Gem</strong></p><p>In terminal, <em>if you use RVM</em>:</p><pre tabindex=0><code>gem install google-api-client
</code></pre><p>If you are running the system ruby, you need to <code>sudo</code> it instead. You can tell if you are running the system ruby by running <code>which ruby</code> and if the answer is <code>/usr/bin/ruby</code>, it&rsquo;s the system one.</p><pre tabindex=0><code>sudo gem install google-api-client
</code></pre><p>Either way, you should see:</p><pre tabindex=0><code>Installing ri documentation for google-api-client-0.5.0...
Installing RDoc documentation for google-api-client-0.5.0...
</code></pre><p>Note that this is a <em>pre-release</em> gem, but it&rsquo;s close to final.</p><p><strong>Install the Plugin</strong></p><p>Download and extract the <code>googleanalyticslogger.rb</code> plugin file from <a href=https://gist.github.com/4072068>Gist 4072068</a>. Then move the <code>googleanalyticslogger.rb</code> file to your Slogger <code>plugins</code> folder.</p><p>Or you can also just create a new <code>googleanalyticslogger.rb</code> in your <code>plugins</code> folder and paste the raw <a href=https://gist.github.com/4072068>gist</a> code in.</p><p><strong>Patch Slogger</strong></p><p><strong>Note: This is critical, the plugin will not work without this patch.</strong></p><p>Open <code>slogger</code> in your favorite programmer&rsquo;s editor and go to line 172, you should see:</p><pre tabindex=0><code>eval(plugin[&#39;class&#39;]).new.do_log
</code></pre><p>Replace it with:</p><pre tabindex=0><code>if plugin[&#39;updates_config&#39;] == true
  # Pass a reference to config for mutation
  eval(plugin[&#39;class&#39;]).new.do_log(@config)
else
  # Usual thing (so that we don&#39;t break other plugins)
  eval(plugin[&#39;class&#39;]).new.do_log
end
</code></pre><figure><img src=images/slga-slogger-patch.jpg width=640 height=286></figure><p>An explanation for this patch is in the &ldquo;How it Works&rdquo; section below.</p><p>Save and close <code>slogger</code></p><p><strong>Optionally: Create your own Google API Client keys</strong></p><p>You may skip this step in the process and use the Google API Client codes that I already set up. <em>I&rsquo;ve not been able to test this on anything but my own account so please let me know if this works.</em></p><p>Just in case, I have included instructions on how to create your own as an appendix to this post.</p><p><strong>Create the slogger_config file entry for this plugin</strong></p><p>As for all plugins, the first thing you need to do is run Slogger to create the <code>slogger_config</code> for it. The <code>-o Google</code> parameter forces Slogger to only run this plugin (and not run all your other plugins and create duplicate Day One entries):</p><pre tabindex=0><code>./slogger -o Google
</code></pre><p>You should see:</p><pre tabindex=0><code>Initializing Slogger v2.0 (2.0.14.2)...
&gt; 11:00:45 GoogleAnalyticsLogger: Google Analytics has not been configured or a feed is invalid, please edit your slogger_config file.
</code></pre><p><strong>Add the Client ID and Secret</strong></p><p>Open <code>slogger_config</code> in your favorite text editor and scroll down to the <strong>GoogleAnalyticsLogger</strong> section.</p><p>Paste in my client ID and secret key (or use your own)</p><pre tabindex=0><code>  client_id: &#34;237632137636.apps.googleusercontent.com&#34;
  client_secret: &#34;xUgp_NqKHnyJ_b8cwZbR1tnX&#34;
</code></pre><figure><img src=images/slga-step-1.jpg width=640 height=246></figure><p>Make sure you save and close <code>slogger_config</code> before moving on to the next step.</p><p><strong>Acquire the Authentication Code</strong></p><p>This is the painful part of OAuth 2.0, you need to authorize this application to access your data. To do so, just run Slogger again.</p><pre tabindex=0><code>./slogger -o Google
</code></pre><p>Slogger will open your default browser and request authorization to access your data.</p><figure><img src=images/slga-step-2-1.jpg width=640 height=200></figure><p>Click Allow Access. It will come back with an one-time Authorization Code.</p><figure><img src=images/slga-step-2-2.jpg width=640 height=97></figure><p>Copy the code and paste it into your <code>slogger_config</code> in the <code>auth_code</code> field.</p><figure><img src=images/slga-step-2-3.jpg width=640 height=95></figure><p>Save and close the file again.</p><p><strong>Acquire the Access Token</strong></p><p>Once more, run</p><pre tabindex=0><code>./slogger -o Google
</code></pre><p>And you should see (Look for &ldquo;Getting access token&rdquo;)</p><pre tabindex=0><code>Initializing Slogger v2.0 (2.0.14.2)...
  11:13:34 GoogleAnalyticsLogger: Logging Google Analytics posts
  11:13:34 GoogleAnalyticsLogger: Run for 2012-11-13 - 2012-11-13
  11:13:34 GoogleAnalyticsLogger: Getting access Token...
</code></pre><p>If you look in your <code>slogger_config</code> now, you should now see an <code>access_token</code> and a <code>refresh_token</code>.</p><figure><img src=images/slga-step-3.jpg width=640 height=93></figure><p>If you do not, check that the <code>slogger</code> patch has been saved, set the <code>auth_code</code> to <code>""</code> and try again.</p><p><strong>Add web properties</strong></p><p>To add web properties, go to your <a href=http://www.google.com/analytics/>Google Analytics home page</a> and sign in.</p><p>Click on &ldquo;All Accounts&rdquo; at the top-left, then expand the first account.</p><figure><img src=images/slga-step-4-1.jpg width=640 height=437></figure><p>Add the UA codes for each property you want to log to the <code>properties</code> list in <code>slogger_config</code>. These are the same codes you use in your site to send stats to Google Analytics.</p><figure><img src=images/slga-step-4-2.jpg width=640 height=95></figure><p><strong>Test that it works</strong></p><p>One more time, dear friends:</p><pre tabindex=0><code>./slogger -o Google
</code></pre><p>And you should see (Note that I ran this on the 14th for two of my properties)</p><pre tabindex=0><code>Initializing Slogger v2.0 (2.0.14.2)...
  11:20:09 GoogleAnalyticsLogger: Logging Google Analytics posts
  11:20:09 GoogleAnalyticsLogger: Run for 2012-11-13 - 2012-11-13
  11:20:10 GoogleAnalyticsLogger: - Getting Site Stats for www.hiltmon.com...
  11:20:11               DayOne: =====[ Saving entry to entries/2B435D2409FA4A729A3DC4C4D4734E07 ]
  11:20:11 GoogleAnalyticsLogger: - Getting Site Stats for www.noverse.com...
  11:20:12               DayOne: =====[ Saving entry to entries/6A30ED73AFD9454197818B1E87C28B10 ]
</code></pre><p>And in <a href=http://dayoneapp.com>DayOne</a>:</p><figure><img src=images/slga-done.jpg width=413 height=480></figure><p>To undo the test, just run</p><pre tabindex=0><code>./slogger -o Google -u 1
</code></pre><p><strong>And you&rsquo;re done</strong></p><p>This plugin should now run every time your scheduled Slogger run occurs.</p><h2 id=how-it-works>How it works</h2><p>This plugin uses the Google Analytics API to retrieve stats for web properties using OAuth 2.0 security.</p><p><strong>Oauth 2.0: Google Style</strong></p><p>The first thing you need to do is create a Google API Client registration at Google (See the Appendix below on how to do this). The most important thing is to tell Google that this is an Installed Application. That way, Google will generate a <code>refresh_token</code> that can be used to enable the application to refresh its own access when the regular <code>access_token</code> expires.</p><p>Even though its an installed application, the first time around, Google OAuth 2.0 requires a user sitting in front of a browser. So I setup the plugin to help with this process.</p><p>If the <code>client_id</code> is not set, the plugin assumes this is the first run, pops a warning and does nothing.</p><p>If the <code>client_id</code> is set, it checks the <code>auth_code</code>. If the <code>auth_code</code> is not set, this must be the second run. The plugin creates an OAuth 2.0 authentication URL and launches the user&rsquo;s browser. The URL is configured such that the resulting <code>auth_code</code> is visible to the user and can be copied and pasted. At some point, I could possibly write code to monitor the browser and get the <code>auth_code</code> but thats too much for now.</p><p>Note that the <code>auth_code</code> is a single use code, once it has been used once, it&rsquo;s useless. We need to convert that to a longer term token. So, if the <code>client_id</code> is set and there is an <code>auth_code</code>, check the <code>access_token</code>. If that is blank, get a new one. Since this is assumed to be the first time, we know that Google also returns the <code>refresh_token</code>. These are saved to the config file (see mutable config below).</p><p>It then checks the <code>access_token</code> to see if it has expired. If so, asks for a new one. <em>This code has not yet been tested, and will probably fail. Two days only!</em></p><p><strong>Mutable Config</strong></p><p>The default Slogger plugin gets a ruby class level copy of the main Slogger config data structure. The problem is, I needed to able to save the <code>access_token</code> and <code>refresh_token</code> as and when they change without user involvement. If you change the copy, it does not change the original, and when Slogger finishes its run and saves the updated config, these changes will be lost.</p><p>I did look at creating a <code>client_secrets.json</code> file as per the gem documentation, but I feel that having more than one configuration file for Slogger was not a good idea.</p><p>So instead, I needed access to the original config data structure, not the class copy. Hence the patch. Now, <code>slogger</code> looks for an <code>updated_config</code> attribute in the registration, and if it is <code>true</code>, passes the config to the plugin directly, else runs all other plugins as usual. This plugin sets <code>'updates_config' => true</code> in its registration.</p><p>I&rsquo;m uncertain whether this is a good or right way to go, but it works for now in the alpha. Note that any updates to Slogger will trash this patch, which means a two-file approach may be better.</p><p><strong>API Discovery</strong></p><p>Once the OAuth 2.0 is done, the plugin &ldquo;discovers&rdquo; the Google Analytics API. This is needed to access it.</p><p><strong>Property Caching</strong></p><p>The plugin then uses the Analytics Management API to download and cache a set of all the web properties accessible to this account. If anything went wrong in OAuth 2.0, we&rsquo;ll find it out here.</p><p><strong>Dates</strong></p><p>The Google Analytics API does not seem to make timestamps available. It does need a <code>start_date</code> and <code>end_date</code> to get data. If you just use these, though, the API sums all the data between the two dates and returns it as one row. Fortunately, it does have a date dimension that can be used.</p><p>Since I want the journal in Day One to have the full set of stats for a date, I setup the plugin to operate up until yesterday, and to do nothing if the last run was after yesterday. That way, you should never see a journal with partial day stats. But you can back fill if you want.</p><p><strong>Properties</strong></p><p>The plugin then runs for each web site that you have a Google Analytics UA code. It uses the cached properties list to convert that into an internal Google site code and get the site name (used in the journal header). If it cannot match the UA code to an entry in the cache, it does nothing.</p><p><strong>The Process</strong></p><p>For each matched site code, it runs the queries. In the alpha, I have these nice and separate for testing, but they can be batched later on.</p><p>Since the date is a dimension field, it means that the Google Analytics API returns a row for each date and each other dimension. For example, in visitors, it returns a row for new visitors and another row for returning visitors <em>for the same date</em>. Which means that I need to take the data returned and consolidate the data by date.</p><p>I created a <code>content</code> hash that is date keyed, and add an array of markdown formatted strings to each date in order that I&rsquo;d like the journal to appear. It&rsquo;s simple, and it works.</p><p>Once all the API queries are done, I loop through the <code>content</code> dates, grab each array of strings, concatenate them into a body and use Slogger to create a new Day One entry for that date as of 11:59PM.</p><p>Feel free to look at the code and let me know what you think. I try to make my early code more explicit to aid debugging, and plan to return later to optimize and idiomize the code.</p><h2 id=appendix-optionally-create-your-own-google-api-client-keys>Appendix: Optionally create your own Google API Client keys</h2><p>So just in case, here&rsquo;s how to create your own Google API client keys:</p><ul><li>Go to the <a href=https://code.google.com/apis/console/>Google API Console</a> and login with the account that you use for Analytics.</li><li>Create a <strong>New API Application</strong></li><li>Enable access to the <strong>Google Analytics API</strong>, and agree to the EULA if necessary.</li><li>Click on <strong>API Access</strong> to create you OAuth2 keys</li><li>Click on <strong>Create an OAuth 2.0 Client ID</strong></li><li>Give it a name and click <strong>next</strong></li><li>Choose <strong>Installed Application</strong>. This is critical or the keys will not work.</li><li>Click <strong>Create Client ID</strong></li></ul><p>You should now see a Client ID and Secret for Installed Applications. Copy and paste these into your <code>slogger_config</code>.</p><p>As always, feel free to comment below on this post, or follow me on App.Net as <a href=http://alpha.app.net/hiltmon>@hiltmon</a> or Twitter as <a href=https://twitter.com/hiltmon>@hiltmon</a>.</p><p>Enjoy.</p></div><p class=post-mark><span class="fas fa-envelope"></span>
<span>Posted By Hilton Lipschitz</span>
&#183;
<span class="fas fa-clock"></span>
<span>Nov 14, 2012 9:14 AM</span></p><div class=pagination><ul><li class=post-previous><a href=https://hiltmon.com/blog/2012/11/15/python-zen/>&larr; Python Zen</a></li><li class=post-center>&nbsp;</li><li class=post-next><a href=https://hiltmon.com/blog/2012/11/12/another-reason-why-i-love-this-community/>Another Reason to love this Community &rarr;</a></li></ul></div></section><aside id=sidebar><script async type=text/javascript src="//cdn.carbonads.com/carbon.js?serve=CKYI52JE&placement=hiltmoncom" id=_carbonads_js></script><section><div id=carbonads></div>&nbsp;</section><section><h1>The Hiltmon Dot Com</h1><p><strong>Hilton Lipschitz</strong> (<a href=https://twitter.com/hiltmon>@hiltmon</a>) an independent software consultant, architect, designer and developer at <a href=https://noverse.com>Noverse LLC</a> (his own small business).</p><p>For the past 22 years he has specialized in the architecture, design, development, operations and trading of bespoke comprehensive front-to-back, multi-asset, <em>automated and algorithmic</em> trading, portfolio management and asset management systems to enable and grow three asset managers.</p><p><a href=https://twitter.com/hiltmon>Twitter</a> &#183;
<a href=https://github.com/hiltmon>Github</a> &#183;
<a href=https://www.linkedin.com/in/hiltmon/>LinkedIn</a> &#183;
<a href=https://hiltmon.com/index.xml>RSS</a></p></section><section><h1>Recent Posts</h1><ul><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/12/go-to-where-the-puck-is-going/>Go to Where the Puck Is Going</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/04/hiltmonism-discoverability-is-deserved/>Discoverability Is Deserved</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/09/13/what-did-i-create-as-an-asset-manager-cto/>What Did I Create as an Asset Manager CTO</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/22/optimizing-short-form-writing-for-developers/>Optimizing Short Form Writing for Developers</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/10/code-review-is-not-all-about-the-code/>Code Review is not all about the Code</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2020/06/07/working-from-home-88-days-later/>Working from Home ... 88 Days Later</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2020/03/14/working-from-home-dot-dot-dot-here-we-go/>Working from Home ... here we go!</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/12/31/the-theater-was-empty/>The Theater was Empty</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/02/16/an-ipad-and-a-pencil/>An iPad and a Pencil</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/02/09/testing-c-plus-plus-17-project-in-xcode-with-xctest/>Testing C++17 Projects in Xcode with XCTest</a></li></ul><section></aside><footer id=footer><p>Copyright &copy; 2022 Hilton Lipschitz</p></footer></div></body></html>