<!doctype html><html><head><meta charset=utf-8><meta name=keywords content><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFJ7SZKLR0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFJ7SZKLR0",{anonymize_ip:!1})}</script><meta name=robots content="index,follow"><link rel=stylesheet href=https://hiltmon.com/css/main.css><link rel=stylesheet href=https://hiltmon.com/css/all.css><link rel=stylesheet href=https://hiltmon.com/css/carbon.css><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic' rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><title>Quick and Dirty Rails Performance Profiling</title></head><body><div id=container><header id=header><img id=logo src=https://hiltmon.com/images/hiltmon-logo-174.png><h1 id=title><a href=https://hiltmon.com/>Hiltmon</a></h1><h2 id=sub-title>On walkabout in life and technology</h2></header><nav id=menu><ul><li><a href=https://hiltmon.com/about/ title="about me">About</a></li><li><a href=https://hiltmon.com/ title="blog section">Blog</a></li><li><a href=https://hiltmon.com/code/ title=code>Code</a></li><li><a href=https://hiltmon.com/tags/ title="tags section">Tags</a></li><li><a href=https://hiltmon.com/archives/ title="archives section">Archives</a></li></ul></nav><section id=content><p class=meta-data><span class=post-date>Feb 27, 2012 10:46 PM</span></p><div class=tag-group><div class=tag><span class=tag-text>| <a href=https://hiltmon.com/tags/ruby-on-rails>Ruby On Rails</a></span></div><div class=tag><span class=tag-text>| <a href=https://hiltmon.com/tags/textmate>TextMate</a></span></div></div><h1 class=post-title>Quick and Dirty Rails Performance Profiling</h1><div class=post-body><p>When I find some Ruby on Rails or Rake tasks running slowly, I throw a quick and dirty profiler around the suspect code to find the bottlenecks with ease. Here&rsquo;s how I do it, maybe this approach can help you too.</p><p>To profile in Ruby on Rails, add the following to your <code>Gemfile</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>gem</span> <span style=color:#c41a16>&#39;ruby-prof&#39;</span>
</span></span></code></pre></div><p>And don&rsquo;t forget to run <code>bundle</code>.</p><p>Add the following file <a href=https://gist.github.com/hiltmon/1929287>Gist 1929287</a> into your <code>lib</code> folder</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>DevelopmentProfiler</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>def</span> <span style=color:#3f6e75>self</span><span style=color:#000>.</span><span style=color:#000>prof</span>(<span style=color:#000>file_name</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>RubyProf</span><span style=color:#000>.</span><span style=color:#000>start</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>yield</span>
</span></span><span style=display:flex><span>    <span style=color:#000>results</span> <span style=color:#000>=</span> <span style=color:#000>RubyProf</span><span style=color:#000>.</span><span style=color:#000>stop</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#177500># Print a flat profile to text</span>
</span></span><span style=display:flex><span>    <span style=color:#000>File</span><span style=color:#000>.</span><span style=color:#000>open</span> <span style=color:#c41a16>&#34;</span><span style=color:#c41a16>#{</span><span style=color:#000>Rails</span><span style=color:#000>.</span><span style=color:#000>root</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/tmp/performance/</span><span style=color:#c41a16>#{</span><span style=color:#000>file_name</span><span style=color:#c41a16>}</span><span style=color:#c41a16>-graph.html&#34;</span>, <span style=color:#c41a16>&#39;w&#39;</span> <span style=color:#a90d91>do</span> <span style=color:#000>|</span><span style=color:#000>file</span><span style=color:#000>|</span>
</span></span><span style=display:flex><span>      <span style=color:#000>RubyProf</span><span style=color:#000>::</span><span style=color:#000>GraphHtmlPrinter</span><span style=color:#000>.</span><span style=color:#000>new</span>(<span style=color:#000>results</span>)<span style=color:#000>.</span><span style=color:#000>print</span>(<span style=color:#000>file</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>File</span><span style=color:#000>.</span><span style=color:#000>open</span> <span style=color:#c41a16>&#34;</span><span style=color:#c41a16>#{</span><span style=color:#000>Rails</span><span style=color:#000>.</span><span style=color:#000>root</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/tmp/performance/</span><span style=color:#c41a16>#{</span><span style=color:#000>file_name</span><span style=color:#c41a16>}</span><span style=color:#c41a16>-flat.txt&#34;</span>, <span style=color:#c41a16>&#39;w&#39;</span> <span style=color:#a90d91>do</span> <span style=color:#000>|</span><span style=color:#000>file</span><span style=color:#000>|</span>
</span></span><span style=display:flex><span>      <span style=color:#177500># RubyProf::FlatPrinter.new(results).print(file)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>RubyProf</span><span style=color:#000>::</span><span style=color:#000>FlatPrinterWithLineNumbers</span><span style=color:#000>.</span><span style=color:#000>new</span>(<span style=color:#000>results</span>)<span style=color:#000>.</span><span style=color:#000>print</span>(<span style=color:#000>file</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>File</span><span style=color:#000>.</span><span style=color:#000>open</span> <span style=color:#c41a16>&#34;</span><span style=color:#c41a16>#{</span><span style=color:#000>Rails</span><span style=color:#000>.</span><span style=color:#000>root</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/tmp/performance/</span><span style=color:#c41a16>#{</span><span style=color:#000>file_name</span><span style=color:#c41a16>}</span><span style=color:#c41a16>-stack.html&#34;</span>, <span style=color:#c41a16>&#39;w&#39;</span> <span style=color:#a90d91>do</span> <span style=color:#000>|</span><span style=color:#000>file</span><span style=color:#000>|</span>
</span></span><span style=display:flex><span>      <span style=color:#000>RubyProf</span><span style=color:#000>::</span><span style=color:#000>CallStackPrinter</span><span style=color:#000>.</span><span style=color:#000>new</span>(<span style=color:#000>results</span>)<span style=color:#000>.</span><span style=color:#000>print</span>(<span style=color:#000>file</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#a90d91>end</span>
</span></span></code></pre></div><p>To use it, just wrap the slow code as follows. Note that the name <code>import</code> is the prefix I want to use on the output files:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>DevelopmentProfiler</span><span style=color:#000>::</span><span style=color:#000>prof</span>(<span style=color:#c41a16>&#34;import&#34;</span>) <span style=color:#a90d91>do</span>
</span></span><span style=display:flex><span>	<span style=color:#177500># Your slow code here</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>end</span>
</span></span></code></pre></div><p>Next time you call this code, via a URL or in a Rake task, it will be profiled and three files will be written to <code>tmp/performance</code>:</p><ul><li><code>import-flat.txt</code>: A text file listing all functions called, the time spent in each and the number of calls made to that function</li><li><code>import-graph.html</code>: A HTML page allowing you to see and drill down the call tree to find where the time is spent.</li><li><code>import-stack.html</code>: A complex HTML stack page that enables you to visualize the profile.</li></ul><p>I use on the <code>import-stack.html</code> file in my quick and dirty approach. Here&rsquo;s what one of these looks like:</p><figure><img src=images/old-profile-stack.png width=600 height=340></figure><p>This profile ran for 36.01 seconds, and spent 18.25% of its time in <code>load_allocations</code>. Looks like we can get some improvement there. So I then expand out the tree to see where in my code it spends the time, how many times something gets called, and then choose which to optimize. One of the excellent features of this view is that the links open TextMate at the line of code being profiled.</p><p>Iterate, optimize, profile, iterate, optimize, and profile again, and I see this:</p><figure><img src=images/new-profile-stack.png width=600 height=396></figure><p>This profile now ran for 26.20 seconds, a huge speed up, with <code>load_allocations</code> using only 7.46% of the <em>shorter</em> runtime. There is much more I can do. I can drill on these stacks for hours finding more and more methods to optimize.</p><p>I usually profile like this in the <em>development</em> environment (most people recommend using a profiling or staging environment). This way I have access to my development database as well as the ability to drop in some quick logging or <code>puts</code> methods to help me see what is going on. <em>I did say it was a quick and dirty approach.</em></p><p>So next time you are wondering why something in Rails or a Rake task is slow, just wrap it in the profiler and drill down the stack to see where the slowdown is.</p></div><p class=post-mark><span class="fas fa-envelope"></span>
<span>Posted By Hilton Lipschitz</span>
&#183;
<span class="fas fa-clock"></span>
<span>Feb 27, 2012 10:46 PM</span></p><div class=pagination><ul><li class=post-previous><a href=https://hiltmon.com/blog/2012/03/01/tsa-fail/>&larr; TSA:Fail</a></li><li class=post-center>&nbsp;</li><li class=post-next><a href=https://hiltmon.com/blog/2012/02/25/iphone-data-plan-follies/>iPhone Data Plan Follies &rarr;</a></li></ul></div></section><aside id=sidebar><script async type=text/javascript src="//cdn.carbonads.com/carbon.js?serve=CKYI52JE&placement=hiltmoncom" id=_carbonads_js></script><section><div id=carbonads></div>&nbsp;</section><section><h1>The Hiltmon Dot Com</h1><p><strong>Hilton Lipschitz</strong> (<a href=https://twitter.com/hiltmon>@hiltmon</a>) an independent software consultant, architect, designer and developer at <a href=https://noverse.com>Noverse LLC</a> (his own small business).</p><p>For the past 23 years he has specialized in the architecture, design, development, operations and trading of bespoke comprehensive front-to-back, multi-asset, <em>automated and algorithmic</em> trading, portfolio management and asset management systems to enable and grow three asset managers.</p><p><a href=https://mastodon.social/@hiltmon rel=me>Mastodon</a> &#183;
<a href=https://twitter.com/hiltmon>Twitter</a> &#183;
<a href=https://github.com/hiltmon>Github</a> &#183;
<a href=https://www.linkedin.com/in/hiltmon/>LinkedIn</a> &#183;
<a href=https://hiltmon.com/index.xml>RSS</a></p></section><section><h1>Recent Posts</h1><ul><li><a class=sidebar-link href=https://hiltmon.com/blog/2023/03/03/xcodes-assistant-editor-struggling-with-cpp/>Xcode's Assistant Editor struggling with C++</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2023/02/11/zero-to-one-stages-of-startup-development/>Zero to One: Stages of Startup Development</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2023/01/01/increasing-file-descriptor-ulimit-on-macos/>Increasing File Descriptor Ulimit on MacOS</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/12/21/who-dares-wins/>Who Dares, Wins</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/11/03/update-hugo-for-node-16-github-pages/>Update Hugo for Node 16 Github Pages</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/11/03/two-months-with-the-m1-macbook-pro/>Two Months with the M1 Macbook Pro</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/26/where-the-rights-are/>Where the Rights Are</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/20/innocuous-birthday-career-advice/>Innocuous Birthday Career Advice</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/12/go-to-where-the-puck-is-going/>Go to Where the Puck Is Going</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/04/hiltmonism-discoverability-is-deserved/>Discoverability Is Deserved</a></li></ul><section></aside><footer id=footer><p>Copyright &copy; 2023 Hilton Lipschitz</p></footer></div></body></html>