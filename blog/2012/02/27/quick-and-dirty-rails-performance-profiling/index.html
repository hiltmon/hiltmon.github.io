<!doctype html><html><head>
<link rel=stylesheet href=/css/main.css>
<link rel=stylesheet href=/css/all.css>
<link rel=stylesheet href=/css/fusion.css>
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic" rel=stylesheet type=text/css>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<title>Quick and Dirty Rails Performance Profiling</title>
</head>
<body>
<div id=container><header id=header>
<img id=logo src=/images/hiltmon-logo-174.png>
<h1 id=title><a href=/>Hiltmon</a></h1>
<h2 id=sub-title>On walkabout in life and technology</h2>
</header>
<nav id=menu>
<ul>
<li>
<a href=/about/ title="about me">About</a>
</li>
<li>
<a href=/code/ title=code>Code</a>
</li>
<li>
<a href=/products/ title=products>Products</a>
</li>
<li>
<a href=/ title="blog section">Blog</a>
</li>
<li>
<a href=/archives/ title="archives section">Archives</a>
</li>
</ul>
</nav>
<section id=content>
<p class=meta-data>
<span class=post-date>Feb 27, 2012 10:46 PM</span>
</p>
<h1 class=post-title>
Quick and Dirty Rails Performance Profiling
</h1>
<div class=post-body>
<p>When I find some Ruby on Rails or Rake tasks running slowly, I throw a quick and dirty profiler around the suspect code to find the bottlenecks with ease. Here&rsquo;s how I do it, maybe this approach can help you too.</p>
<p>To profile in Ruby on Rails, add the following to your <code>Gemfile</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby>gem <span style=color:#87ceeb>&#39;ruby-prof&#39;</span>
</code></pre></div><p>And don&rsquo;t forget to run <code>bundle</code>.</p>
<p>Add the following file <a href=https://gist.github.com/hiltmon/1929287>Gist 1929287</a> into your <code>lib</code> folder</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=color:red>class</span> DevelopmentProfiler
  
  <span style=color:red>def</span> self.<span style=color:#ff0>prof</span>(file_name)
    
    <span style=color:#7fffd4>RubyProf</span>.start
    <span style=color:red>yield</span>
    results = <span style=color:#7fffd4>RubyProf</span>.stop
    
    <span style=color:#0f0># Print a flat profile to text</span>
    <span style=color:#7fffd4>File</span>.open <span style=color:#87ceeb>&#34;</span><span style=color:#87ceeb>#{</span><span style=color:#7fffd4>Rails</span>.root<span style=color:#87ceeb>}</span><span style=color:#87ceeb>/tmp/performance/</span><span style=color:#87ceeb>#{</span>file_name<span style=color:#87ceeb>}</span><span style=color:#87ceeb>-graph.html&#34;</span>, <span style=color:#87ceeb>&#39;w&#39;</span> <span style=color:red>do</span> |file|
      <span style=color:#7fffd4>RubyProf</span>::<span style=color:#7fffd4>GraphHtmlPrinter</span>.new(results).print(file)
    <span style=color:red>end</span>
 
    <span style=color:#7fffd4>File</span>.open <span style=color:#87ceeb>&#34;</span><span style=color:#87ceeb>#{</span><span style=color:#7fffd4>Rails</span>.root<span style=color:#87ceeb>}</span><span style=color:#87ceeb>/tmp/performance/</span><span style=color:#87ceeb>#{</span>file_name<span style=color:#87ceeb>}</span><span style=color:#87ceeb>-flat.txt&#34;</span>, <span style=color:#87ceeb>&#39;w&#39;</span> <span style=color:red>do</span> |file|
      <span style=color:#0f0># RubyProf::FlatPrinter.new(results).print(file)</span>
      <span style=color:#7fffd4>RubyProf</span>::<span style=color:#7fffd4>FlatPrinterWithLineNumbers</span>.new(results).print(file)
    <span style=color:red>end</span>
 
    <span style=color:#7fffd4>File</span>.open <span style=color:#87ceeb>&#34;</span><span style=color:#87ceeb>#{</span><span style=color:#7fffd4>Rails</span>.root<span style=color:#87ceeb>}</span><span style=color:#87ceeb>/tmp/performance/</span><span style=color:#87ceeb>#{</span>file_name<span style=color:#87ceeb>}</span><span style=color:#87ceeb>-stack.html&#34;</span>, <span style=color:#87ceeb>&#39;w&#39;</span> <span style=color:red>do</span> |file|
      <span style=color:#7fffd4>RubyProf</span>::<span style=color:#7fffd4>CallStackPrinter</span>.new(results).print(file)
    <span style=color:red>end</span>
 
  <span style=color:red>end</span>
  
<span style=color:red>end</span>
</code></pre></div><p>To use it, just wrap the slow code as follows. Note that the name <code>import</code> is the prefix I want to use on the output files:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=color:#7fffd4>DevelopmentProfiler</span>::prof(<span style=color:#87ceeb>&#34;import&#34;</span>) <span style=color:red>do</span>
	<span style=color:#0f0># Your slow code here</span>
<span style=color:red>end</span>
</code></pre></div><p>Next time you call this code, via a URL or in a Rake task, it will be profiled and three files will be written to <code>tmp/performance</code>:</p>
<ul>
<li><code>import-flat.txt</code>: A text file listing all functions called, the time spent in each and the number of calls made to that function</li>
<li><code>import-graph.html</code>: A HTML page allowing you to see and drill down the call tree to find where the time is spent.</li>
<li><code>import-stack.html</code>: A complex HTML stack page that enables you to visualize the profile.</li>
</ul>
<p>I use on the <code>import-stack.html</code> file in my quick and dirty approach. Here&rsquo;s what one of these looks like:</p>
<figure><img src=images/old-profile-stack.png width=600 height=340>
</figure>
<p>This profile ran for 36.01 seconds, and spent 18.25% of its time in <code>load_allocations</code>. Looks like we can get some improvement there. So I then expand out the tree to see where in my code it spends the time, how many times something gets called, and then choose which to optimize. One of the excellent features of this view is that the links open TextMate at the line of code being profiled.</p>
<p>Iterate, optimize, profile, iterate, optimize, and profile again, and I see this:</p>
<figure><img src=images/new-profile-stack.png width=600 height=396>
</figure>
<p>This profile now ran for 26.20 seconds, a huge speed up, with <code>load_allocations</code> using only 7.46% of the <em>shorter</em> runtime. There is much more I can do. I can drill on these stacks for hours finding more and more methods to optimize.</p>
<p>I usually profile like this in the <em>development</em> environment (most people recommend using a profiling or staging environment). This way I have access to my development database as well as the ability to drop in some quick logging or <code>puts</code> methods to help me see what is going on. <em>I did say it was a quick and dirty approach.</em></p>
<p>So next time you are wondering why something in Rails or a Rake task is slow, just wrap it in the profiler and drill down the stack to see where the slowdown is.</p>
</div>
<p class=post-mark>
<span class="fas fa-envelope"></span>
<span>Posted By Hilton Lipschitz</span>
&#183;
<span class="fas fa-clock"></span>
<span>Feb 27, 2012 10:46 PM</span>
</p>
<div class=pagination>
<ul>
<li class=post-previous><a href=https://hiltmon.github.io/blog/2012/03/01/tsa-fail/>&larr; TSA:Fail</a></li>
<li class=post-center>&nbsp;</li>
<li class=post-next><a href=https://hiltmon.github.io/blog/2012/02/25/iphone-data-plan-follies/>iPhone Data Plan Follies &rarr;</a></li>
</ul>
</div>
</section><aside id=sidebar>
<section>
<h1>The Hiltmon Dot Com</h1>
<p><strong>Hilton Lipschitz</strong> (<a href=https://twitter.com/hiltmon>@hiltmon</a>) is CTO of an up and coming Hedge Fund, who loves to craft brilliant and delightful web, iPhone, iPad and Macintosh software products. Before this he was an independent software consultant, designer and developer at <a href=http://www.noverse.com>Noverse LLC</a>.</p>
</section><section>
<h1>Recent Posts</h1>
<ul>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2020/06/07/working-from-home-88-days-later/>Working from Home ... 88 Days Later</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2020/03/14/working-from-home-dot-dot-dot-here-we-go/>Working from Home ... here we go!</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2019/12/31/the-theater-was-empty/>The Theater was Empty</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2019/02/16/an-ipad-and-a-pencil/>An iPad and a Pencil</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2019/02/09/testing-c-plus-plus-17-project-in-xcode-with-xctest/>Testing C++17 Projects in Xcode with XCTest</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2018/06/17/on-removing-comments/>On Removing Comments</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2018/06/17/stop-and-think/>Stop and Think</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2017/08/31/migrate-octopress-slash-jekyll-posts-to-ulysses/>Migrate Octopress / Jekyll Posts to Ulysses</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2017/03/12/notification-city/>Notification City</a></li>
<li><a class=sidebar-link href=https://hiltmon.github.io/blog/2017/03/05/coding-style-standards-in-2017/>Coding Style Standards in 2017</a></li>
</ul>
<section></aside><footer id=footer>
<p>Copyright &copy; 2022 Hilton Lipschitz</p>
</footer></div>
</body>
</html>