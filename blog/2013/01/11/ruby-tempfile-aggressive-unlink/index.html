<!doctype html><html><head><meta charset=utf-8><meta name=keywords content><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFJ7SZKLR0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFJ7SZKLR0",{anonymize_ip:!1})}</script><meta name=robots content="index,follow"><link rel=stylesheet href=https://hiltmon.com/css/main.css><link rel=stylesheet href=https://hiltmon.com/css/all.css><link rel=stylesheet href=https://hiltmon.com/css/carbon.css><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic' rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><title>Ruby Tempfile Aggressive Unlink</title></head><body><div id=container><header id=header><img id=logo src=https://hiltmon.com/images/hiltmon-logo-174.png><h1 id=title><a href=https://hiltmon.com/>Hiltmon</a></h1><h2 id=sub-title>On walkabout in life and technology</h2></header><nav id=menu><ul><li><a href=https://hiltmon.com/about/ title="about me">About</a></li><li><a href=https://hiltmon.com/ title="blog section">Blog</a></li><li><a href=https://hiltmon.com/code/ title=code>Code</a></li><li><a href=https://hiltmon.com/tags/ title="tags section">Tags</a></li><li><a href=https://hiltmon.com/archives/ title="archives section">Archives</a></li></ul></nav><section id=content><p class=meta-data><span class=post-date>Jan 11, 2013 10:49 AM</span></p><div class=tag-group><div class=tag><span class=tag-text>| <a href=https://hiltmon.com/tags/ruby-on-rails>Ruby on Rails</a></span></div></div><h1 class=post-title>Ruby Tempfile Aggressive Unlink</h1><div class=post-body><p>I often use Ruby’s <code>Tempfile</code> class when generating files in Rails for download. But something went wrong in the Rails 3.2.11 update.</p><p>Here is the code I normally use (as per the <a href=http://www.ruby-doc.org/stdlib-1.9.3/libdoc/tempfile/rdoc/Tempfile.html>Tempfile documentation</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>begin</span> 
</span></span><span style=display:flex><span>  <span style=color:#000>temp</span> <span style=color:#000>=</span> <span style=color:#000>Tempfile</span><span style=color:#000>.</span><span style=color:#000>new</span>(<span style=color:#000>“</span><span style=color:#000>temp</span><span style=color:#000>-</span><span style=color:#000>file</span><span style=color:#000>-</span><span style=color:#a90d91>name</span><span style=color:#000>.</span><span style=color:#000>xlsx</span><span style=color:#000>”</span>) 
</span></span><span style=display:flex><span>  <span style=color:#000>report</span> <span style=color:#000>=</span> <span style=color:#000>ReportClass</span><span style=color:#000>.</span><span style=color:#000>new</span>(<span style=color:#000>temp</span><span style=color:#000>.</span><span style=color:#000>path</span>, <span style=color:#000>params</span>)
</span></span><span style=display:flex><span>  <span style=color:#000>report</span><span style=color:#000>.</span><span style=color:#000>generate</span>
</span></span><span style=display:flex><span>  <span style=color:#000>send_file</span> <span style=color:#000>temp</span><span style=color:#000>.</span><span style=color:#000>path</span>, <span style=color:#c41a16>:filename</span> <span style=color:#000>=&gt;</span> <span style=color:#000>“</span><span style=color:#177500>#{user_file_name}.xlsx&#34;, :type =&gt; &#34;application/xlsx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>ensure</span>
</span></span><span style=display:flex><span>  <span style=color:#000>temp</span><span style=color:#000>.</span><span style=color:#000>close</span>
</span></span><span style=display:flex><span>  <span style=color:#000>temp</span><span style=color:#000>.</span><span style=color:#000>unlink</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span><span style=color:#000>...</span>
</span></span></code></pre></div><p>In short, create a temp file, stream the data to it in the report class, then send the file to the user. Ensure the file is closed and deleted after. Prior to Rails 3.2.11, this worked fine.</p><p>The problem after the 3.2.11 update is that the <code>temp.unlink</code> was happening <em>before</em> the file got sent (or maybe while it was being sent), leading to blank or corrupted files.</p><p>It turns out, the <code>temp.unlink</code> is not necessary any more. As long as you close a Tempfile using <code>temp.close</code>, Ruby’s Garbage Collector will delete the file for you, <em>once it no longer needs it</em>. Which means that the <code>send_file</code> will have a file available to send. I monitored my temp folder and it does indeed do this.</p><p>So, remove the <code>temp.unlink</code> line in Rails 3.2.11 projects, and ignore the documentation. You can now generate and send files from Rails again.</p><p><em>Follow the author as <a href=https://twitter.com/hiltmon>@hiltmon</a> on Twitter or <a href=http://alpha.app.net/hiltmon>@hiltmon</a> on App.Net.</em></p></div><p class=post-mark><span class="fas fa-envelope"></span>
<span>Posted By Hilton Lipschitz</span>
&#183;
<span class="fas fa-clock"></span>
<span>Jan 11, 2013 10:49 AM</span></p><div class=pagination><ul><li class=post-previous><a href=https://hiltmon.com/blog/2013/01/12/workable-social-network-connection-heuristics/>&larr; Workable Social Network Connection Heuristics</a></li><li class=post-center>&nbsp;</li><li class=post-next><a href=https://hiltmon.com/blog/2013/01/07/reprogramming-my-brace-style-mind/>Reprogramming my Brace Style Mind &rarr;</a></li></ul></div></section><aside id=sidebar><script async type=text/javascript src="//cdn.carbonads.com/carbon.js?serve=CKYI52JE&placement=hiltmoncom" id=_carbonads_js></script><section><div id=carbonads></div>&nbsp;</section><section><h1>The Hiltmon Dot Com</h1><p><strong>Hilton Lipschitz</strong> (<a href=https://twitter.com/hiltmon>@hiltmon</a>) an independent software consultant, architect, designer and developer at <a href=https://noverse.com>Noverse LLC</a> (his own small business).</p><p>For the past 22 years he has specialized in the architecture, design, development, operations and trading of bespoke comprehensive front-to-back, multi-asset, <em>automated and algorithmic</em> trading, portfolio management and asset management systems to enable and grow three asset managers.</p><p><a href=https://mastodon.social/@hiltmon>Mastodon</a> &#183;
<a href=https://twitter.com/hiltmon>Twitter</a> &#183;
<a href=https://github.com/hiltmon>Github</a> &#183;
<a href=https://www.linkedin.com/in/hiltmon/>LinkedIn</a> &#183;
<a href=https://hiltmon.com/index.xml>RSS</a></p></section><section><h1>Recent Posts</h1><ul><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/12/21/who-dares-wins/>Who Dares, Wins</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/11/03/update-hugo-for-node-16-github-pages/>Update Hugo for Node 16 Github Pages</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/11/03/two-months-with-the-m1-macbook-pro/>Two Months with the M1 Macbook Pro</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/26/where-the-rights-are/>Where the Rights Are</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/20/innocuous-birthday-career-advice/>Innocuous Birthday Career Advice</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/12/go-to-where-the-puck-is-going/>Go to Where the Puck Is Going</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/04/hiltmonism-discoverability-is-deserved/>Discoverability Is Deserved</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/09/13/what-did-i-create-as-an-asset-manager-cto/>What Did I Create as an Asset Manager CTO</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/22/optimizing-short-form-writing-for-developers/>Optimizing Short Form Writing for Developers</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/10/code-review-is-not-all-about-the-code/>Code Review is not all about the Code</a></li></ul><section></aside><footer id=footer><p>Copyright &copy; 2022 Hilton Lipschitz</p></footer></div></body></html>