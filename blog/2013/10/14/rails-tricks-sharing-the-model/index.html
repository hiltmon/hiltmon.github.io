<!doctype html><html><head><meta charset=utf-8><meta name=keywords content><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFJ7SZKLR0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZFJ7SZKLR0",{anonymize_ip:!1})}</script><meta name=robots content="index,follow"><link rel=stylesheet href=https://hiltmon.com/css/main.css><link rel=stylesheet href=https://hiltmon.com/css/all.css><link rel=stylesheet href=https://hiltmon.com/css/carbon.css><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic' rel=stylesheet type=text/css><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><title>Rails Tricks - Sharing the Model</title></head><body><div id=container><header id=header><img id=logo src=https://hiltmon.com/images/hiltmon-logo-174.png><h1 id=title><a href=https://hiltmon.com/>Hiltmon</a></h1><h2 id=sub-title>On walkabout in life and technology</h2></header><nav id=menu><ul><li><a href=https://hiltmon.com/about/ title="about me">About</a></li><li><a href=https://hiltmon.com/ title="blog section">Blog</a></li><li><a href=https://hiltmon.com/code/ title=code>Code</a></li><li><a href=https://hiltmon.com/tags/ title="tags section">Tags</a></li><li><a href=https://hiltmon.com/archives/ title="archives section">Archives</a></li></ul></nav><section id=content><p class=meta-data><span class=post-date>Oct 14, 2013 1:58 PM</span></p><div class=tag-group><div class=tag><span class=tag-text>| <a href=https://hiltmon.com/tags/ruby-on-rails>Ruby on Rails</a></span></div></div><h1 class=post-title>Rails Tricks - Sharing the Model</h1><div class=post-body><p>I am building a series of Rails applications for different users and use cases, but they all hang off the <em>same</em> database schema. Using canonical Rails, that means a single, massive rails app with a bunch of controllers, a heap of views and a complex security model.</p><p>I prefer small, focussed apps, so I decided to share the model instead. Here&rsquo;s how it works.</p><h2 id=sharing-the-model>Sharing the model</h2><p>Lets call the the first rails project <em>Master</em>. Generate it as usual and create a few models and migrations to set up the database. In my case, the <em>Master</em> rails application is used to do nothing more than import, export and allow users to view the data in the model&rsquo;s database tables.</p><pre><code>rails new Master --database postgresql
cd Master
rails generate model model1 ...
...
rake db:create
rake db:migrate
</code></pre><p>Lets now create a reporting app, called <em>Reporting</em> that will use the same model as <em>Master</em>.</p><pre><code>cd ..
rails new Reporting --database postgresql
cd Reporting
</code></pre><p><strong>Do not create any models or migrations in this project, you do them all in <em>Master</em>.</strong></p><p>To copy the models, create a new <code>rake</code> task in a new file in <em>Reporting</em> called <code>lib/tasks/sync.rake</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#000>namespace</span> <span style=color:#c41a16>:sync</span> <span style=color:#a90d91>do</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#000>desc</span> <span style=color:#c41a16>&#39;Copy common models and tests from Master&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>task</span> <span style=color:#c41a16>:copy</span> <span style=color:#a90d91>do</span>
</span></span><span style=display:flex><span>    <span style=color:#000>source_path</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#39;/Users/Hiltmon/Projects/Master&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>dest_path</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#39;/Users/Hiltmon/Projects/Reporting&#39;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#177500># Copy all models &amp; tests</span>
</span></span><span style=display:flex><span>    <span style=color:#c41a16>%x{cp </span><span style=color:#c41a16>#{</span><span style=color:#000>source_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/app/models/*.rb </span><span style=color:#c41a16>#{</span><span style=color:#000>dest_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/app/models/}</span>
</span></span><span style=display:flex><span>    <span style=color:#c41a16>%x{cp </span><span style=color:#c41a16>#{</span><span style=color:#000>source_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/test/models/*_test.rb </span><span style=color:#c41a16>#{</span><span style=color:#000>dest_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/test/models/}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500># Fixtures</span>
</span></span><span style=display:flex><span>    <span style=color:#c41a16>%x{cp </span><span style=color:#c41a16>#{</span><span style=color:#000>source_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/test/fixtures/*.yml </span><span style=color:#c41a16>#{</span><span style=color:#000>dest_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/test/fixtures/}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#177500># Database YML</span>
</span></span><span style=display:flex><span>    <span style=color:#c41a16>%x{cp </span><span style=color:#c41a16>#{</span><span style=color:#000>source_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/config/database.yml </span><span style=color:#c41a16>#{</span><span style=color:#000>dest_path</span><span style=color:#c41a16>}</span><span style=color:#c41a16>/config/database.yml}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>end</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>end</span>
</span></span></code></pre></div><p>Change the <code>source_path</code> to point to the root of the <em>Master</em> project and the <code>dest_path</code> to point to the root of the <em>Reporting</em> project. The run it:</p><pre><code>rake sync:copy
</code></pre><p>The script copies the <code>app/models</code>, <code>test/models</code>, <code>test/fixtures</code> and <code>database.yml</code> files from <em>Master</em> to <em>Reporting</em>. As far as Rails is concerned, these were created via genuine rails commands and the Rails engine will make these models available in your reporting views and controllers. The <code>database.yml</code> file will also make Rails point to the same database as <em>Master</em>.</p><p>Two rules need to be followed to make this work:</p><ol><li>All models or migrations are done in <em>Master</em> and only in <em>Master</em>. That includes any changes to model files.</li><li>Run a <code>rake sync:copy</code> every once in a while to bring the <em>Reporting</em> project up to date after changes in <em>Master</em>.</li></ol><p>Top Tips:</p><ul><li>If you run <code>rake db:migrate</code> in the <em>Reporting</em> project, no harm will be done (because there are no migrations in it). But the <code>schema.rb</code> file will be regenerated. Which is cool.</li><li>You can add additional projects that use the same shared model, I have 5 at the moment.</li></ul><h2 id=rejected-options>Rejected Options</h2><p>I could have just symlinked the model and db folders between the projects, and therefore not needed the <code>rake</code> task. But that only works for a single development system and single developer. I would have to relink for each new computer or developer that needs to work on these projects.</p><p>I also could have used <code>git</code> submodules to provide a common repository for the copied code, but that would mean that I could not use the regular <code>rails</code> and <code>rake</code> commands for models and migrations, which defeats the purpose of using Rails.</p><h2 id=result>Result</h2><p>As a result of sharing (ok, copying) the models this way, I have several Rails applications running off different servers providing different services to different users all running off the same back-end database. Each application is smaller, simpler, easier to manage and easier to code and maintain. As long as discipline is maintained in that the models and migrations are only performed in the <em>Master</em> project, this trick works great.</p><p><em>Follow the author as <a href=https://twitter.com/hiltmon>@hiltmon</a> on Twitter and <a href=http://alpha.app.net/hiltmon>@hiltmon</a> on App.Net. Mute <code>#xpost</code> on one.</em></p></div><p class=post-mark><span class="fas fa-envelope"></span>
<span>Posted By Hilton Lipschitz</span>
&#183;
<span class="fas fa-clock"></span>
<span>Oct 14, 2013 1:58 PM</span></p><div class=pagination><ul><li class=post-previous><a href=https://hiltmon.com/blog/2013/10/14/detox-expands-t-dot-co-links/>&larr; Sanity Saver: Detox expands t.co links</a></li><li class=post-center>&nbsp;</li><li class=post-next><a href=https://hiltmon.com/blog/2013/10/13/why-microsoft-word-must-die/>Why Microsoft Word must Die &rarr;</a></li></ul></div></section><aside id=sidebar><script async type=text/javascript src="//cdn.carbonads.com/carbon.js?serve=CKYI52JE&placement=hiltmoncom" id=_carbonads_js></script><section><div id=carbonads></div>&nbsp;</section><section><h1>The Hiltmon Dot Com</h1><p><strong>Hilton Lipschitz</strong> (<a href=https://twitter.com/hiltmon>@hiltmon</a>) an independent software consultant, architect, designer and developer at <a href=https://noverse.com>Noverse LLC</a> (his own small business).</p><p>For the past 22 years he has specialized in the architecture, design, development, operations and trading of bespoke comprehensive front-to-back, multi-asset, <em>automated and algorithmic</em> trading, portfolio management and asset management systems to enable and grow three asset managers.</p><p><a href=https://twitter.com/hiltmon>Twitter</a> &#183;
<a href=https://github.com/hiltmon>Github</a> &#183;
<a href=https://www.linkedin.com/in/hiltmon/>LinkedIn</a> &#183;
<a href=https://hiltmon.com/index.xml>RSS</a></p></section><section><h1>Recent Posts</h1><ul><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/12/go-to-where-the-puck-is-going/>Go to Where the Puck Is Going</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/10/04/hiltmonism-discoverability-is-deserved/>Discoverability Is Deserved</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/09/13/what-did-i-create-as-an-asset-manager-cto/>What Did I Create as an Asset Manager CTO</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/22/optimizing-short-form-writing-for-developers/>Optimizing Short Form Writing for Developers</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2022/08/10/code-review-is-not-all-about-the-code/>Code Review is not all about the Code</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2020/06/07/working-from-home-88-days-later/>Working from Home ... 88 Days Later</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2020/03/14/working-from-home-dot-dot-dot-here-we-go/>Working from Home ... here we go!</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/12/31/the-theater-was-empty/>The Theater was Empty</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/02/16/an-ipad-and-a-pencil/>An iPad and a Pencil</a></li><li><a class=sidebar-link href=https://hiltmon.com/blog/2019/02/09/testing-c-plus-plus-17-project-in-xcode-with-xctest/>Testing C++17 Projects in Xcode with XCTest</a></li></ul><section></aside><footer id=footer><p>Copyright &copy; 2022 Hilton Lipschitz</p></footer></div></body></html>